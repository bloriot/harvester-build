# Harvester Build Automation

This repository contains automation scripts to streamline the process of building [Harvester](https://github.com/harvester/harvester) images.

It provides two main tools:
1.  **`build_harvester.sh`**: Automates the compilation of the Harvester ISO and standard QCOW2 images from source.
2.  **`build-efi-raw-image.sh`**: Converts the built ISO into a pre-installed, compressed raw disk image specifically configured for **UEFI boot** environments.

---

## 1. Build Harvester ISO/QCOW (`build_harvester.sh`)

This script handles the setup of the build environment (SLES or Ubuntu) and executes the build process using the official `harvester-installer` repository.

### Prerequisites
* **Root Privileges (`sudo`):** Required to install Docker and system packages.
* **OS:** SUSE Linux Enterprise Server (SLES) or Ubuntu.
* **Internet Access:** To fetch Docker images and git repositories.

### Usage

**Basic Usage (Build ISO)**

By default, this builds version `v1.7.0`.
```bash
sudo ./build_harvester.sh
```

**Build Raw QCOW Image**

To build a standard QCOW2 image (useful for basic virtualization), set the BUILD_QCOW flag. Note: This triggers the installation of KVM/QEMU dependencies.

```bash
sudo BUILD_QCOW="true" ./build_harvester.sh
```

**Build a Specific Version**

To build a different branch or tag (e.g., master):

```bash
sudo HARVESTER_BRANCH="master" ./build_harvester.sh
```

### Outputs

**Outputs Artifacts** are stored in: `./harvester-build/harvester-installer/dist/artifacts`.

## 2. Build EFI Raw Image (build-efi-raw-image.sh)

This script takes the ISO generated by the previous step and creates a compressed raw disk image (.raw.zst) pre-installed with Harvester, specifically configured for UEFI boot. This is essential for environments that strictly require EFI firmware.

### Prerequisites
* **Harvester ISO**: Must be present in dist/artifacts (generated by Step 1).
* **Virtualization**: Host must support KVM (/dev/kvm).
* **Tools**: qemu-system-x86_64, qemu-img, zstd (script checks for these).

### Usage

```bash
# Run with sudo to access KVM
sudo ./build-efi-raw-image.sh
```

### How it Works

1.  **Auto-Detection**: Automatically locates the latest ISO in dist/artifacts and finds the correct OVMF (UEFI) firmware for your OS.
2.  **VM Provisioning**: Boots a temporary QEMU VM with UEFI firmware and the Harvester ISO.
3.  **Automated Install**: Injects kernel parameters to trigger a fully automated installation to a virtual disk.
4.  **Compression**: Compresses the final raw disk image using zstd.

### Outputs

**Compressed Image** is stored in `dist/artifacts/harvester-<version>-amd64.raw.zst`.
